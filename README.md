# Обход сгоревшего контроллера приборной панели (комбинации приборов) на Ford Focus 1

## История проблемы

Автомобиль Ford Focus 2003 года выпуска. В какой-то момент стрелка уровня топлива перестала работать. Могла остаться в нуле или уйти в за пределы полного бака (возможно, от вибрации).
Постоянно светился индикатор низкого уровня топлива (даже с полным баком). Датчик уровня топлива исправен: сопротивление между 8 и 15 контактами разъёма, идущего к приборной панели, было ожидаемым (ожидается для пустого бака - около 15 Ом, для полного бака - около 160 Ом).

В автосервисе сказали, что сгорел контроллер и надо менять приборную панель (они есть в продаже с разборок). Но непонятно, на сколько будут правильные показания, ведь приборная панель была откалибрована под другой экземпляр автомобиля. К тому, просто поменять - это не так интересно :)

## Изучение

На приборной панели установлено 4 одинаковых шаговых двигателя, которые управляют стрелками температуры, скорости, тахометра и уровня топлива. Для управления шаговыми двигателями контроллер использует уровни от 0 до 5 вольт с использованием ШИМ (широтно-импульсной подуляции), что бы разделить шаги на микрошаги.

## Решение проблемы

1. Перерезал дорожки, идущие от контроллера к шаговому двигателю, управляющему стрелкой уровня топлива.
2. Подпаял к шаговому двигателю отладочную плату на драйвере TMC2209 (покупал на Озоне: https://www.ozon.ru/product/3-shtuki-mks-tmc2209-v3-0-drayver-shagovogo-dvigatelya-novaya-versiya-1368294229/ ).
3. Драйвером управляю с STM32F103C8T6 (использовал дешёвую отладочную плату).
4. Для определения уровня топлива завёл сигнал с разъёма с контакта 8 (идущего от датчика уровня топлива) на STM32 и определяю напряжение через встроенный АЦП.
5. Для управления светодидом, сигнализирующим о низком уровне топлива, так же была перерезана дорожка, идущая от контроллера к светодиоду, а к самому светодиоду подпаян провод и подключен к STM32.
